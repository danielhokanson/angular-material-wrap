<div class="amw-chips" 
     [class]="config.classes"
     [class.amw-chips--disabled]="disabled"
     [class.amw-chips--error]="hasError"
     [class.amw-chips--small]="size === 'small'"
     [class.amw-chips--medium]="size === 'medium'"
     [class.amw-chips--large]="size === 'large'"
     [class.amw-chips--filled]="appearance === 'filled'"
     [class.amw-chips--outlined]="appearance === 'outlined'"
     [attr.aria-label]="ariaLabel"
     [attr.aria-describedby]="ariaDescribedby">

  <!-- Chips Container -->
  <mat-chip-set 
    class="amw-chips__container"
    [class.amw-chips__container--selectable]="selectable"
    [class.amw-chips__container--multiple]="multiple">
    
    <!-- Individual Chips -->
    <mat-chip 
      *ngFor="let chip of internalChips; let i = index; trackBy: trackByChipId"
      class="amw-chips__chip"
      [class.amw-chips__chip--selected]="chip.selected"
      [class.amw-chips__chip--disabled]="chip.disabled"
      [class.amw-chips__chip--removable]="canRemoveChip(chip)"
      [class.amw-chips__chip--selectable]="canSelectChip(chip)"
      [class.amw-chips__chip--menu]="shouldShowMenu(chip)"
      [class]="chip.classes"
      [disabled]="chip.disabled"
      [removable]="canRemoveChip(chip)"
      [matTooltip]="chip.label"
      [matTooltipDisabled]="chip.label.length < 20"
      (click)="canSelectChip(chip) && selectChip(chip, i)"
      (removed)="removeChip(chip, i)"
      [attr.aria-label]="chip.label"
      [attr.aria-selected]="chip.selected"
      [attr.aria-disabled]="chip.disabled">
      
      <!-- Chip Avatar (if provided) -->
      <img *ngIf="chip.avatar" 
           class="amw-chips__chip-avatar"
           [src]="chip.avatar" 
           [alt]="chip.label">
      
      <!-- Chip Icon (if provided) -->
      <mat-icon *ngIf="chip.icon && !chip.avatar" 
                class="amw-chips__chip-icon">
        {{ chip.icon }}
      </mat-icon>
      
      <!-- Chip Label -->
      <span class="amw-chips__chip-label">{{ chip.label }}</span>
      
      <!-- Menu Button -->
      <button *ngIf="shouldShowMenu(chip)"
              class="amw-chips__chip-menu"
              mat-icon-button
              [matMenuTriggerFor]="chipMenu"
              [attr.aria-label]="'Menu for ' + chip.label"
              (click)="openMenu(chip, $event)">
        <span class="amw-chips__menu-icon">⋮</span>
      </button>

      <!-- Remove Button -->
      <button *ngIf="canRemoveChip(chip)"
              class="amw-chips__chip-remove"
              matChipRemove
              [attr.aria-label]="'Remove ' + chip.label"
              (click)="$event.stopPropagation()">
        <mat-icon>close</mat-icon>
      </button>
    </mat-chip>
  </mat-chip-set>

  <!-- Chip Menu Template -->
  <mat-menu #chipMenu class="amw-chips__menu">
    <button *ngFor="let menuItem of getCurrentMenuItems(); let isLast = last"
            mat-menu-item
            class="amw-chips__menu-item"
            [class]="menuItem.classes"
            [disabled]="menuItem.disabled"
            (click)="onMenuItemClick(currentChip!, menuItem)">
      <mat-icon *ngIf="menuItem.icon" class="amw-chips__menu-item-icon">
        {{ menuItem.icon }}
      </mat-icon>
      <span class="amw-chips__menu-item-label">{{ menuItem.label }}</span>
    </button>
    <mat-divider *ngIf="getCurrentMenuItems().length > 1"></mat-divider>
  </mat-menu>

  <!-- Input Field (if enabled) -->
  <mat-form-field *ngIf="showInput && addable" 
                  class="amw-chips__input"
                  appearance="outline"
                  [class.amw-chips__input--focused]="isInputFocused">
    
    <mat-label *ngIf="placeholder">{{ placeholder }}</mat-label>
    
    <input matInput
           class="amw-chips__input-field"
           [(ngModel)]="inputValue"
           [disabled]="disabled"
           [required]="required"
           [placeholder]="placeholder"
           [attr.aria-label]="'Add chip input'"
           [attr.aria-describedby]="ariaDescribedby"
           (keydown)="onInputKeydown($event)"
           (input)="onInputChange($event.target.value)"
           (focus)="onInputFocus()"
           (blur)="onInputBlur()"
           [matAutocomplete]="suggestionsPanel">
    
    <!-- Suggestions Panel -->
    <mat-autocomplete #suggestionsPanel="matAutocomplete"
                      class="amw-chips__suggestions"
                      [displayWith]="displayChipLabel"
                      (optionSelected)="onSuggestionSelected($event)">
      
      <mat-option *ngFor="let suggestion of filteredSuggestions; trackBy: trackByChipId"
                  [value]="suggestion"
                  class="amw-chips__suggestion">
        {{ suggestion.label }}
      </mat-option>
    </mat-autocomplete>
    
    <!-- Error State -->
    <mat-error *ngIf="hasError && errorMessage" 
               class="amw-chips__error">
      {{ errorMessage }}
    </mat-error>
    
    <!-- Hint Text -->
    <mat-hint *ngIf="!hasError && (maxChips || minChips)" 
              class="amw-chips__hint">
      <span *ngIf="maxChips">Max {{ maxChips }} chips</span>
      <span *ngIf="minChips && maxChips"> • </span>
      <span *ngIf="minChips">Min {{ minChips }} chips</span>
    </mat-hint>
  </mat-form-field>

  <!-- Action Buttons -->
  <div *ngIf="!showInput && addable" 
       class="amw-chips__actions">
    
    <button mat-icon-button
            class="amw-chips__add-button"
            [disabled]="disabled || (maxChips && internalChips.length >= maxChips)"
            [matTooltip]="'Add chip'"
            (click)="focusInput()">
      <mat-icon>add</mat-icon>
    </button>
    
    <button *ngIf="internalChips.length > 0"
            mat-icon-button
            class="amw-chips__clear-button"
            [disabled]="disabled"
            [matTooltip]="'Clear all chips'"
            (click)="clearChips()">
      <mat-icon>clear_all</mat-icon>
    </button>
  </div>

  <!-- Hidden Input for Focus Management -->
  <input *ngIf="!showInput && addable"
         #hiddenInput
         class="amw-chips__hidden-input"
         [disabled]="disabled"
         [placeholder]="placeholder"
         (keydown)="onInputKeydown($event)"
         (input)="onInputChange($event.target.value)"
         (focus)="onInputFocus()"
         (blur)="onInputBlur()">
</div>
