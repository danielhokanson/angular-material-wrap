<div class="amw-chips"
  [class]="config().classes"
  [class.amw-chips--disabled]="isDisabled"
  [class.amw-chips--error]="hasErrorState()"
  [class.amw-chips--small]="size() === 'small'"
  [class.amw-chips--medium]="size() === 'medium'"
  [class.amw-chips--large]="size() === 'large'"
  [class.amw-chips--filled]="appearance() === 'filled'"
  [class.amw-chips--outlined]="appearance() === 'outlined'"
  [attr.aria-label]="ariaLabel()"
  [attr.aria-describedby]="ariaDescribedby()">

  <!-- Chips Container -->
  <mat-chip-set
    class="amw-chips__container"
    [class.amw-chips__container--selectable]="selectable()"
    [class.amw-chips__container--multiple]="multiple()">

    <!-- Individual Chips -->
    @for (chip of internalChips; track trackByChipId(i, chip); let i = $index) {
      <mat-chip
        class="amw-chips__chip"
        [class.amw-chips__chip--selected]="chip.selected"
        [class.amw-chips__chip--disabled]="chip.disabled"
        [class.amw-chips__chip--removable]="canRemoveChip(chip)"
        [class.amw-chips__chip--selectable]="canSelectChip(chip)"
        [class.amw-chips__chip--menu]="shouldShowMenu(chip)"
        [class]="chip.classes"
        [disabled]="chip.disabled"
        [removable]="canRemoveChip(chip)"
        [amwTooltip]="chip.label"
        [tooltipDisabled]="chip.label.length < 20"
        (click)="canSelectChip(chip) && selectChip(chip, i)"
        (removed)="removeChip(chip, i)"
        [attr.aria-label]="chip.label"
        [attr.aria-selected]="chip.selected"
        [attr.aria-disabled]="chip.disabled">
        <!-- Chip Avatar (if provided) -->
        @if (chip.avatar) {
          <img
            class="amw-chips__chip-avatar"
            [src]="chip.avatar"
            [alt]="chip.label">
        }
        <!-- Chip Icon (if provided) -->
        @if (chip.icon && !chip.avatar) {
          <mat-icon
            class="amw-chips__chip-icon">
            {{ chip.icon }}
          </mat-icon>
        }
        <!-- Chip Label -->
        <span class="amw-chips__chip-label">{{ chip.label }}</span>
        <!-- Menu Button -->
        @if (shouldShowMenu(chip)) {
          <amw-button
            class="amw-chips__chip-menu"
            [matMenuTriggerFor]="chipMenu"
            [attr.aria-label]="'Menu for ' + chip.label"
            (click)="openMenu(chip, $event)">
            <span class="amw-chips__menu-icon">⋮</span>
          </amw-button>
        }
        <!-- Remove Button -->
        @if (canRemoveChip(chip)) {
          <button
            class="amw-chips__chip-remove"
            matChipRemove
            [attr.aria-label]="'Remove ' + chip.label"
            (click)="$event.stopPropagation()">
            <mat-icon>close</mat-icon>
          </button>
        }
      </mat-chip>
    }
  </mat-chip-set>

  <!-- Chip Menu Template -->
  <mat-menu #chipMenu class="amw-chips__menu">
    @for (menuItem of getCurrentMenuItems(); track menuItem; let isLast = $last) {
      <button
        mat-menu-item
        class="amw-chips__menu-item"
        [class]="menuItem.classes"
        [disabled]="menuItem.disabled"
        (click)="onMenuItemClick(currentChip!, menuItem)">
        @if (menuItem.icon) {
          <mat-icon class="amw-chips__menu-item-icon">
            {{ menuItem.icon }}
          </mat-icon>
        }
        <span class="amw-chips__menu-item-label">{{ menuItem.label }}</span>
      </button>
    }
    @if (getCurrentMenuItems().length > 1) {
      <amw-divider></amw-divider>
    }
  </mat-menu>

  <!-- Input Field (if enabled) -->
  @if (showInput() && addable()) {
    <mat-form-field
      class="amw-chips__input"
      appearance="outline"
      [class.amw-chips__input--focused]="isInputFocused">
      @if (placeholder()) {
        <mat-label>{{ placeholder() }}</mat-label>
      }
      <input matInput
        class="amw-chips__input-field"
        [(ngModel)]="inputValue"
        [disabled]="isDisabled"
        [required]="required()"
        [placeholder]="placeholder()"
        [attr.aria-label]="'Add chip input'"
        [attr.aria-describedby]="ariaDescribedby()"
        (keydown)="onInputKeydown($event)"
        (input)="onInputChange($event.target.value)"
        (focus)="onInputFocus()"
        (blur)="onInputBlur()"
        [matAutocomplete]="suggestionsPanel">
      <!-- Suggestions Panel -->
      <mat-autocomplete #suggestionsPanel="matAutocomplete"
        class="amw-chips__suggestions"
        [displayWith]="displayChipLabel"
        (optionSelected)="onSuggestionSelected($event)">
        @for (suggestion of filteredSuggestions; track trackByChipId($index, suggestion)) {
          <mat-option
            [value]="suggestion"
            class="amw-chips__suggestion">
            {{ suggestion.label }}
          </mat-option>
        }
      </mat-autocomplete>
      <!-- Error State -->
      @if (hasErrorState() && getErrorMessage()) {
        <mat-error
          class="amw-chips__error">
          {{ getErrorMessage() }}
        </mat-error>
      }
      <!-- Hint Text -->
      @if (!hasErrorState() && (maxChips() || minChips())) {
        <mat-hint
          class="amw-chips__hint">
          @if (maxChips()) {
            <span>Max {{ maxChips() }} chips</span>
          }
          @if (minChips() && maxChips()) {
            <span> • </span>
          }
          @if (minChips()) {
            <span>Min {{ minChips() }} chips</span>
          }
        </mat-hint>
      }
    </mat-form-field>
  }

  <!-- Action Buttons -->
  @if (!showInput() && addable()) {
    <div
      class="amw-chips__actions">
      <amw-button
        icon="add"
        class="amw-chips__add-button"
        [disabled]="isDisabled || !!(maxChips() && internalChips.length >= maxChips()!)"
        [amwTooltip]="'Add chip'"
        (click)="focusInput()">
      </amw-button>
      @if (internalChips.length > 0) {
        <amw-button
          icon="clear_all"
          class="amw-chips__clear-button"
          [disabled]="isDisabled"
          [amwTooltip]="'Clear all chips'"
          (click)="clearChips()">
        </amw-button>
      }
    </div>
  }

  <!-- Hidden Input for Focus Management -->
  @if (!showInput() && addable()) {
    <input
      #hiddenInput
      class="amw-chips__hidden-input"
      [disabled]="isDisabled"
      [placeholder]="placeholder()"
      (keydown)="onInputKeydown($event)"
      (input)="onInputChange($event.target.value)"
      (focus)="onInputFocus()"
      (blur)="onInputBlur()">
  }
</div>
