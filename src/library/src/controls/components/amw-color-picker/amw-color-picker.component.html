<div class="amw-color-picker" [class]="'amw-color-picker--' + size() + ' amw-color-picker--' + mode()">
  <mat-form-field [appearance]="config().appearance || 'outline'" cdkOverlayOrigin #trigger="cdkOverlayOrigin">
    @if (label()) {
      <mat-label>{{ label() }}</mat-label>
    }

    <input
      matInput
      [value]="selectedColor()"
      [placeholder]="placeholder()"
      [disabled]="isDisabled"
      [required]="required()"
      readonly
      (click)="toggleColorPicker()"
      (focus)="onFocus($event)"
      (blur)="onBlur($event)"
      />

    <amw-button
      variant="icon"
      icon="palette"
      matSuffix
      type="button"
      [disabled]="isDisabled"
      (click)="toggleColorPicker()"
      aria-label="Open color picker">
    </amw-button>

    @if (hasValidationError) {
      <mat-error>
        {{ errorText }}
      </mat-error>
    }
  </mat-form-field>

  <!-- Color Preview -->
  @if (showPreview() && selectedColor()) {
    <div class="amw-color-picker__preview">
      <div
        class="amw-color-picker__preview-color"
        [style.background-color]="displayColor()"
        [title]="selectedColor()"
      ></div>
      <span class="amw-color-picker__preview-text">{{ selectedColor() }}</span>
    </div>
  }

  <!-- Color Picker Dropdown - Using CDK Overlay to escape container clipping -->
  <ng-template
    cdkConnectedOverlay
    [cdkConnectedOverlayOrigin]="trigger"
    [cdkConnectedOverlayOpen]="isOpen()"
    [cdkConnectedOverlayPositions]="overlayPositions"
    [cdkConnectedOverlayHasBackdrop]="true"
    [cdkConnectedOverlayBackdropClass]="'amw-color-picker__backdrop'"
    (backdropClick)="isOpen.set(false)"
    (detach)="isOpen.set(false)">
    <div class="amw-color-picker__dropdown" (click)="$event.stopPropagation()">
      <div class="amw-color-picker__header">
        <span class="amw-color-picker__title">Select Color</span>
        <amw-button variant="icon" icon="close" (click)="isOpen.set(false)" aria-label="Close">
        </amw-button>
      </div>
      <div class="amw-color-picker__content">
        <!-- Palette Colors -->
        @if (showPalette()) {
          <div class="amw-color-picker__palette">
            <div class="amw-color-picker__palette-title">Color Palette</div>
            <div class="amw-color-picker__palette-grid">
              @for (color of paletteColors(); track color) {
                <amw-button
                  variant="icon"
                  [icon]="selectedColor() === color ? 'check' : ''"
                  class="amw-color-picker__color-button"
                  [class.amw-color-picker__color-button--selected]="selectedColor() === color"
                  [style.background-color]="color"
                  [title]="color"
                  (click)="selectColor(color)"
                  [disabled]="isDisabled">
                </amw-button>
              }
            </div>
          </div>
        }
        <!-- Custom Color Gradient Picker -->
        @if (showCustom()) {
          <div class="amw-color-picker__custom">
            <div class="amw-color-picker__custom-title">Custom Color</div>

            <!-- HSV Gradient Area -->
            <div
              class="amw-color-picker__gradient-area"
              #gradientArea
              (mousedown)="onGradientMouseDown($event)"
              [style.background]="gradientBackground()">
              <div class="amw-color-picker__gradient-white"></div>
              <div class="amw-color-picker__gradient-black"></div>
              <div
                class="amw-color-picker__gradient-cursor"
                [style.left]="gradientCursorX()"
                [style.top]="gradientCursorY()">
              </div>
            </div>

            <!-- Hue Slider -->
            <div
              class="amw-color-picker__hue-slider"
              #hueSlider
              (mousedown)="onHueMouseDown($event)">
              <div
                class="amw-color-picker__hue-cursor"
                [style.left]="hueCursorX()">
              </div>
            </div>

            <!-- Color Preview and Hex Input -->
            <div class="amw-color-picker__custom-input">
              <div
                class="amw-color-picker__custom-preview"
                [style.background-color]="hsvColor()">
              </div>
              <input
                type="text"
                [value]="customColor()"
                (input)="onCustomColorChange($any($event.target).value)"
                [disabled]="isDisabled"
                placeholder="#000000"
                class="amw-color-picker__text-input"
                />
            </div>
          </div>
        }
        <!-- Text Input -->
        @if (showInput()) {
          <div class="amw-color-picker__text">
            <div class="amw-color-picker__text-title">Color Value</div>
            <input
              type="text"
              [value]="selectedColor()"
              (input)="onInputChange($event)"
              [disabled]="isDisabled"
              placeholder="Enter color value"
              class="amw-color-picker__text-field"
              />
          </div>
        }
      </div>
      <div class="amw-color-picker__actions">
        <amw-button variant="text" (click)="isOpen.set(false)">Cancel</amw-button>
        <amw-button variant="text" color="primary" (click)="selectColor(selectedColor())">OK</amw-button>
      </div>
    </div>
  </ng-template>
</div>
