<div class="amw-autocomplete"
     [class]="'amw-autocomplete--' + size()"
     [class.amw-autocomplete--loading]="loading()">
  <mat-form-field [appearance]="appearance()" class="amw-autocomplete__field">
    @if (label()) {
      <mat-label [innerHTML]="label()"></mat-label>
    }

    <!-- Start Icon (prefix) -->
    @if (startIcon()) {
      <mat-icon matPrefix class="amw-autocomplete__start-icon">{{ startIcon() }}</mat-icon>
    }

    <!-- Signal Forms binding (scenario 3) - Field directive manages disabled, required, readonly automatically -->
    @if (field()) {
      <input
        matInput
        [field]="field()"
        [placeholder]="placeholder()"
        [value]="inputValue"
        (input)="onInputChange($event)"
        (blur)="onTouched()"
        [matAutocomplete]="auto"
        class="amw-autocomplete__input">
    } @else {
      <!-- ngModel / Reactive Forms binding (scenarios 1 & 2) -->
      <input
        matInput
        [placeholder]="placeholder()"
        [value]="inputValue"
        (input)="onInputChange($event)"
        (blur)="onTouched()"
        [required]="required()"
        [disabled]="disabled() || loading()"
        [readonly]="readonly()"
        [attr.minlength]="minLength() || null"
        [attr.maxlength]="maxLength() || null"
        [matAutocomplete]="auto"
        class="amw-autocomplete__input">
    }

    <!-- Loading Spinner -->
    @if (loading()) {
      <mat-spinner matSuffix [diameter]="20" class="amw-autocomplete__spinner"></mat-spinner>
    }

    @if (!loading() && !multiple() && clearable() && (selectedValue || inputValue)) {
      <mat-icon
        matSuffix
        (click)="onClear()"
        class="amw-autocomplete__clear">
        clear
      </mat-icon>
    }

    @if (hint()) {
      <mat-hint class="amw-autocomplete__hint">{{ hint() }}</mat-hint>
    }
  </mat-form-field>

  <!-- Multiple selection chips -->
  @if (multiple() && selectedValues.length > 0) {
    <div class="amw-autocomplete__chips">
      <mat-chip-set>
        @for (value of selectedValues; track value) {
          <mat-chip
            [removable]="!disabled()"
            (removed)="onChipRemoved(value)"
            class="amw-autocomplete__chip">
            <span [innerHTML]="getSelectedOption(value)?.label || value"></span>
            @if (!disabled()) {
              <button matChipRemove>
                <mat-icon>cancel</mat-icon>
              </button>
            }
          </mat-chip>
        }
      </mat-chip-set>
    </div>
  }

  <!-- Autocomplete panel -->
  <mat-autocomplete
    #auto="matAutocomplete"
    (opened)="onOpened()"
    (closed)="onClosed()"
    [displayWith]="displayWith()"
    class="amw-autocomplete__panel">

    <!-- Loading indicator in dropdown -->
    @if (loading() && filteredOptions.length === 0) {
      <mat-option disabled class="amw-autocomplete__loading-option">
        <mat-spinner [diameter]="20"></mat-spinner>
        <span>Loading...</span>
      </mat-option>
    }

    @for (option of filteredOptions; track option) {
      <mat-option
        [value]="option"
        [disabled]="option.disabled"
        (onSelectionChange)="onOptionSelected(option)"
        class="amw-autocomplete__option">
        <!-- Custom template or default -->
        @if (optionTemplate) {
          <ng-container *ngTemplateOutlet="optionTemplate; context: { $implicit: option }"></ng-container>
        } @else {
          <span [innerHTML]="option.label"></span>
        }
      </mat-option>
    }

    @if (!loading() && filteredOptions.length === 0 && inputValue.length >= minLength()) {
      <mat-option
        disabled
        class="amw-autocomplete__no-results">
        {{ noResultsText() }}
      </mat-option>
    }
  </mat-autocomplete>
</div>
