<div class="amw-select">
  <mat-form-field
    [appearance]="appearance()"
    [class]="'amw-select__field ' + selectClasses()"
    [floatLabel]="label() ? 'always' : 'auto'"
    [hideRequiredMarker]="!required()"
    [class.mat-form-field-invalid]="hasValidationError">

    <!-- Label -->
    @if (label()) {
      <mat-label [innerHTML]="label()"></mat-label>
    }

    <!-- Shared options content template -->
    <ng-template #selectOptionsContent>
      <!-- Search Box (if enabled) -->
      @if (searchable() && showSearchBox()) {
        <mat-option disabled class="amw-select__search-option">
          <input
            matInput
            [placeholder]="searchPlaceholder()"
            [value]="searchValue()"
            (input)="onSearchChange($any($event.target).value || '')"
            class="amw-select__search-input"
            (click)="$event.stopPropagation()">
        </mat-option>
      }

      <!-- Clear Button (if enabled) -->
      @if (canClear()) {
        <mat-option (click)="onClear()" class="amw-select__clear-option">
          <mat-icon class="amw-select__clear-icon">clear</mat-icon>
          Clear Selection
        </mat-option>
      }

      <!-- Loading Option -->
      @if (loading()) {
        <mat-option disabled class="amw-select__loading-option">
          <amw-progress-spinner [diameter]="20" class="amw-select__loading-spinner"></amw-progress-spinner>
          {{ loadingText() }}
        </mat-option>
      }

      <!-- No Options Message -->
      @if (!loading() && !hasOptions()) {
        <mat-option disabled class="amw-select__no-options">
          {{ noOptionsText() }}
        </mat-option>
      }

      <!-- Regular Options -->
      @for (option of filteredOptions(); track option) {
        <mat-option
          [value]="option.value"
          [disabled]="option.disabled"
          [class.amw-select__option]="true"
          [class.amw-select__option--disabled]="option.disabled">
          <div class="amw-select__option-content">
            @if (option.icon) {
              <mat-icon class="amw-select__option-icon">{{ option.icon }}</mat-icon>
            }
            <div class="amw-select__option-text">
              <span class="amw-select__option-label" [innerHTML]="option.label"></span>
              @if (option.description) {
                <span class="amw-select__option-description">{{ option.description }}</span>
              }
            </div>
          </div>
        </mat-option>
      }

      <!-- Grouped Options -->
      @for (group of filteredGroups() | keyvalue; track group) {
        <mat-optgroup
          [label]="group.key"
          class="amw-select__group">
          @for (option of group.value; track option) {
            <mat-option
              [value]="option.value"
              [disabled]="option.disabled"
              [class.amw-select__option]="true"
              [class.amw-select__option--disabled]="option.disabled">
              <div class="amw-select__option-content">
                @if (option.icon) {
                  <mat-icon class="amw-select__option-icon">{{ option.icon }}</mat-icon>
                }
                <div class="amw-select__option-text">
                  <span class="amw-select__option-label" [innerHTML]="option.label"></span>
                  @if (option.description) {
                    <span class="amw-select__option-description">{{ option.description }}</span>
                  }
                </div>
              </div>
            </mat-option>
          }
        </mat-optgroup>
      }
    </ng-template>

    <!-- Select Element -->
    <!-- Signal Forms binding (scenario 3) - FormField directive manages disabled, required automatically -->
    @if (formField()) {
      <mat-select
        [formField]="formField()"
        [placeholder]="placeholder()"
        [multiple]="multiple()"
        [compareWith]="compareWith()"
        [panelClass]="panelClass()"
        [disableRipple]="disableRipple()"
        [attr.aria-label]="ariaLabel()"
        [attr.aria-labelledby]="ariaLabelledby()"
        [attr.aria-describedby]="ariaDescribedby()"
        [attr.tabindex]="tabIndex()"
        [attr.autofocus]="autofocus()"
        [attr.id]="id()"
        (selectionChange)="onSelectionChange($event.value)"
        (openedChange)="onOpenedChange($event)"
        (focus)="onFocus($event)"
        (blur)="onBlur($event)"
        class="amw-select__field">
        <ng-container *ngTemplateOutlet="selectOptionsContent"></ng-container>
      </mat-select>
    } @else {
      <!-- ngModel / Reactive Forms binding (scenarios 1 & 2) -->
      <mat-select
        [placeholder]="placeholder()"
        [disabled]="disabled()"
        [required]="required()"
        [multiple]="multiple()"
        [compareWith]="compareWith()"
        [value]="internalValue()"
        [panelClass]="panelClass()"
        [disableRipple]="disableRipple()"
        [attr.aria-label]="ariaLabel()"
        [attr.aria-labelledby]="ariaLabelledby()"
        [attr.aria-describedby]="ariaDescribedby()"
        [attr.tabindex]="tabIndex()"
        [attr.autofocus]="autofocus()"
        [attr.id]="id()"
        (selectionChange)="onSelectionChange($event.value)"
        (openedChange)="onOpenedChange($event)"
        (focus)="onFocus($event)"
        (blur)="onBlur($event)"
        class="amw-select__field">
        <ng-container *ngTemplateOutlet="selectOptionsContent"></ng-container>
      </mat-select>
    }

    <!-- Hint Text -->
    @if (hint() && !hasValidationError) {
      <mat-hint class="amw-select__hint">{{ hint() }}</mat-hint>
    }

    <!-- Error Message -->
    @if (hasValidationError) {
      <mat-error class="amw-select__error">
        {{ errorText }}
      </mat-error>
    }
  </mat-form-field>
</div>
