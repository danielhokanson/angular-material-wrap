<div class="amw-data-table" [class]="'amw-data-table--' + (config.size || 'medium')">
  <!-- Header with search and actions -->
  <div class="amw-data-table__header" *ngIf="filterable || actions.length > 0">
    <div class="amw-data-table__search" *ngIf="filterable">
      <mat-form-field appearance="outline" class="amw-data-table__search-field">
        <mat-label>Search</mat-label>
        <input
          matInput
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
          placeholder="Search data..."
        />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>
    
    <div class="amw-data-table__actions">
      <button
        mat-icon-button
        matTooltip="Clear filters"
        (click)="clearFilters()"
        [disabled]="!hasFilters"
      >
        <mat-icon>clear</mat-icon>
      </button>
      
      <button
        mat-icon-button
        [matMenuTriggerFor]="exportMenu"
        matTooltip="Export data"
        [disabled]="!hasData"
      >
        <mat-icon>download</mat-icon>
      </button>
      
      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="exportData('csv')">
          <mat-icon>file_download</mat-icon>
          <span>Export as CSV</span>
        </button>
        <button mat-menu-item (click)="exportData('json')">
          <mat-icon>file_download</mat-icon>
          <span>Export as JSON</span>
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- Column filters -->
  <div class="amw-data-table__filters" *ngIf="filterable && columns.length > 0">
    <div class="amw-data-table__filter-row">
      <div
        *ngFor="let column of columns"
        class="amw-data-table__filter-cell"
        [class.amw-data-table__filter-cell--hidden]="column.hidden"
      >
        <mat-form-field appearance="outline" *ngIf="column.filterable !== false">
          <mat-label>{{ column.label || column.key }}</mat-label>
          <input
            matInput
            [(ngModel)]="columnFilters[column.key]"
            (input)="onColumnFilterChange(column.key, $event.target.value)"
            [placeholder]="'Filter ' + (column.label || column.key)"
          />
        </mat-form-field>
      </div>
    </div>
  </div>

  <!-- Data table -->
  <div class="amw-data-table__container">
    <table mat-table
      [dataSource]="displayedData"
      matSort
      (matSortChange)="onSortChange($event)"
      class="amw-data-table__table"
    >
      <!-- Selection column -->
      <ng-container matColumnDef="select" *ngIf="selectable">
        <mat-header-cell *matHeaderCellDef>
          <mat-checkbox
            [checked]="allSelected"
            [indeterminate]="someSelected"
            (change)="onSelectAllChange($event.checked)"
            [disabled]="loading"
          ></mat-checkbox>
        </mat-header-cell>
        <mat-cell *matCellDef="let row; let i = index">
          <mat-checkbox
            [checked]="isRowSelected(row)"
            (change)="onRowSelectChange(row, $event.checked)"
            [disabled]="loading"
          ></mat-checkbox>
        </mat-cell>
      </ng-container>

      <!-- Data columns -->
      <ng-container *ngFor="let column of columns" [matColumnDef]="column.key">
        <mat-header-cell *matHeaderCellDef [mat-sort-header]="sortable && column.sortable !== false ? column.key : ''">
          {{ column.label || column.key }}
        </mat-header-cell>
        <mat-cell *matCellDef="let row; let i = index">
          <ng-container [ngSwitch]="column.type">
            <!-- Text -->
            <span *ngSwitchCase="'text'">{{ getCellDisplayValue(row, column) }}</span>
            
            <!-- Number -->
            <span *ngSwitchCase="'number'">{{ getCellDisplayValue(row, column) }}</span>
            
            <!-- Currency -->
            <span *ngSwitchCase="'currency'">{{ getCellDisplayValue(row, column) }}</span>
            
            <!-- Date -->
            <span *ngSwitchCase="'date'">{{ getCellDisplayValue(row, column) }}</span>
            
            <!-- Boolean -->
            <mat-icon *ngSwitchCase="'boolean'" [class]="'amw-data-table__boolean-icon amw-data-table__boolean-icon--' + (getCellValue(row, column) ? 'true' : 'false')">
              {{ getCellValue(row, column) ? 'check_circle' : 'cancel' }}
            </mat-icon>
            
            <!-- Custom template -->
            <ng-container *ngSwitchCase="'custom'" [ngTemplateOutlet]="column.template" [ngTemplateOutletContext]="{ $implicit: row, index: i, column: column }"></ng-container>
            
            <!-- Default -->
            <span *ngSwitchDefault>{{ getCellDisplayValue(row, column) }}</span>
          </ng-container>
        </mat-cell>
      </ng-container>

      <!-- Actions column -->
      <ng-container matColumnDef="actions" *ngIf="actions.length > 0">
        <mat-header-cell *matHeaderCellDef>Actions</mat-header-cell>
        <mat-cell *matCellDef="let row; let i = index">
          <button
            mat-icon-button
            [matMenuTriggerFor]="actionMenu"
            [disabled]="loading"
          >
            <mat-icon>more_vert</mat-icon>
          </button>
          
          <mat-menu #actionMenu="matMenu">
            <button
              *ngFor="let action of actions"
              mat-menu-item
              (click)="onActionClick(action, row, i)"
              [disabled]="action.disabled && action.disabled(row, i)"
            >
              <mat-icon>{{ action.icon }}</mat-icon>
              <span>{{ action.label }}</span>
            </button>
          </mat-menu>
        </mat-cell>
      </ng-container>
    </table>

    <!-- Loading spinner -->
    <div class="amw-data-table__loading" *ngIf="loading">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading data...</p>
    </div>

    <!-- Empty state -->
    <div class="amw-data-table__empty" *ngIf="!loading && !hasData">
      <mat-icon class="amw-data-table__empty-icon">{{ noDataIcon }}</mat-icon>
      <p class="amw-data-table__empty-message">{{ emptyMessage }}</p>
    </div>
  </div>

  <!-- Pagination -->
  <mat-paginator
    *ngIf="pageable && hasData"
    [length]="page.length"
    [pageSize]="page.pageSize"
    [pageSizeOptions]="[5, 10, 25, 50, 100]"
    [pageIndex]="page.pageIndex"
    (page)="onPageChange($event)"
    showFirstLastButtons
    class="amw-data-table__paginator"
  ></mat-paginator>

  <!-- Selection summary -->
  <div class="amw-data-table__selection" *ngIf="selectedRows.length > 0">
    <span class="amw-data-table__selection-text">
      {{ selectedRows.length }} item{{ selectedRows.length === 1 ? '' : 's' }} selected
    </span>
    <button mat-button (click)="selectedRows = []; selectionChange.emit(selectedRows)">
      Clear selection
    </button>
  </div>
</div>
