<div class="amw-form-page" [ngClass]="currentConfig.customClasses" [ngStyle]="currentConfig.customStyles">
  <!-- Header -->
  <div class="amw-form-page__header">
    <div class="amw-form-page__header-content">
      <div class="amw-form-page__header-text">
        <h1 class="amw-form-page__title">{{ currentConfig.title }}</h1>
        @if (currentConfig.subtitle) {
          <p class="amw-form-page__subtitle">{{ currentConfig.subtitle }}</p>
        }
      </div>

      <div class="amw-form-page__header-actions">
        @if (currentConfig.showSaveButton) {
          <amw-button variant="elevated" icon="save" iconPosition="left" color="primary" (click)="onSave()"
            [disabled]="!form.valid || saving">
            {{ saving ? 'Saving...' : 'Save' }}
          </amw-button>
        }
        @if (currentConfig.showCancelButton) {
          <amw-button variant="elevated" icon="cancel" iconPosition="left" (click)="onCancel()">
            Cancel
          </amw-button>
        }
        @if (currentConfig.showResetButton) {
          <amw-button variant="elevated" icon="refresh" iconPosition="left" (click)="onReset()">
            Reset
          </amw-button>
        }
        @if (currentConfig.showPreviewButton) {
          <amw-button variant="elevated" icon="preview" iconPosition="left" (click)="onPreview()">
            Preview
          </amw-button>
        }
        @if (currentConfig.showPrintButton) {
          <amw-button variant="elevated" icon="print" iconPosition="left" (click)="onPrint()">
            Print
          </amw-button>
        }
      </div>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading) {
    <div class="amw-form-page__loading">
      <amw-progress-spinner [diameter]="40"></amw-progress-spinner>
      <p>Loading data...</p>
    </div>
  }

  <!-- Error State -->
  @if (error && !loading) {
    <div class="amw-form-page__error">
      <mat-icon>error</mat-icon>
      <p>{{ error }}</p>
      <amw-button variant="elevated" color="primary" (click)="loadData()">Retry</amw-button>
    </div>
  }

  <!-- Form Content -->
  @if (!loading && !error) {
    <form [formGroup]="form" (ngSubmit)="onSave()" class="amw-form-page__form">
      <div class="amw-form-page__sections">
        @for (section of currentConfig.sections; track section) {
          <mat-card
            class="amw-form-page__section"
            [style.display]="isSectionVisible(section) ? 'block' : 'none'">
            <mat-card-header>
              <mat-card-title>{{ section.title }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="amw-form-page__fields">
                @for (field of section.fields; track field) {
                  <div
                    class="amw-form-page__field"
                    [style.display]="isFieldVisible(field) ? 'block' : 'none'">
                    <!-- Text Input -->
                    @if (field.type === 'text' || field.type === 'email' || field.type === 'password') {
                      <amw-input
                        [label]="field.label"
                        [formControlName]="field.key"
                        [type]="field.type"
                        [placeholder]="field.placeholder || ''"
                        [maxlength]="field.validation?.maxlength || null"
                        appearance="outline">
                        <mat-error>{{ getFieldError(field) }}</mat-error>
                      </amw-input>
                    }
                    <!-- Number Input -->
                    @if (field.type === 'number') {
                      <amw-input
                        [label]="field.label"
                        type="number"
                        [formControlName]="field.key"
                        [placeholder]="field.placeholder || ''"
                        [min]="field.validation?.min || null"
                        [max]="field.validation?.max || null"
                        appearance="outline">
                        <mat-error>{{ getFieldError(field) }}</mat-error>
                      </amw-input>
                    }
                    <!-- Textarea -->
                    @if (field.type === 'textarea') {
                      <amw-textarea
                        [label]="field.label"
                        [formControlName]="field.key"
                        [placeholder]="field.placeholder || ''"
                        [maxlength]="field.validation?.maxlength || null"
                        [rows]="4"
                        appearance="outline">
                        <mat-error>{{ getFieldError(field) }}</mat-error>
                      </amw-textarea>
                    }
                    <!-- Select -->
                    @if (field.type === 'select') {
                      <amw-select
                        [label]="field.label"
                        [formControlName]="field.key"
                        [options]="field.options || []"
                        appearance="outline">
                      </amw-select>
                      @if (getFieldError(field)) {
                        <div class="field-error">{{ getFieldError(field) }}</div>
                      }
                    }
                    <!-- Checkbox -->
                    @if (field.type === 'checkbox') {
                      <div class="amw-form-page__checkbox">
                        <amw-checkbox [formControlName]="field.key">
                          {{ field.label }}
                        </amw-checkbox>
                        <mat-error>{{ getFieldError(field) }}</mat-error>
                      </div>
                    }
                    <!-- Radio Group -->
                    @if (field.type === 'radio') {
                      <div class="amw-form-page__radio">
                        <label class="amw-form-page__radio-label">{{ field.label }}</label>
                        <amw-radio-group [formControlName]="field.key">
                          @for (option of field.options; track option) {
                            <amw-radio [radioValue]="option.value">
                              {{ option.label }}
                            </amw-radio>
                          }
                        </amw-radio-group>
                        <mat-error>{{ getFieldError(field) }}</mat-error>
                      </div>
                    }
                    <!-- Date Picker -->
                    @if (field.type === 'date') {
                      <amw-datepicker
                        [label]="field.label"
                        [formControlName]="field.key"
                        [placeholder]="field.placeholder || ''"
                        appearance="outline">
                      </amw-datepicker>
                    }
                    <!-- Chips -->
                    @if (field.type === 'chips') {
                      <mat-form-field appearance="outline">
                        <mat-label>{{ field.label }}</mat-label>
                        <mat-chip-grid #chipGrid [formControlName]="field.key">
                          @for (chip of form.get(field.key)?.value || []; track chip) {
                            <mat-chip-row
                              (removed)="removeChip(field, chip)">
                              {{ chip }}
                              <amw-button variant="icon" icon="cancel" matChipRemove>
                              </amw-button>
                            </mat-chip-row>
                          }
                          <input placeholder="Add new item..."
                            [matChipInputFor]="chipGrid"
                            [matChipInputSeparatorKeyCodes]="[13, 188]"
                            (matChipInputTokenEnd)="addChip(field, $event)">
                        </mat-chip-grid>
                        <mat-error>{{ getFieldError(field) }}</mat-error>
                      </mat-form-field>
                    }
                  </div>
                }
              </div>
            </mat-card-content>
          </mat-card>
        }
      </div>
    </form>
  }
</div>