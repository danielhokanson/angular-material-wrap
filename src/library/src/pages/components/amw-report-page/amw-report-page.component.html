<div class="amw-report-page" [ngClass]="currentConfig.customClasses" [ngStyle]="currentConfig.customStyles">
  <!-- Header -->
  <div class="amw-report-page__header">
    <div class="amw-report-page__header-content">
      <div class="amw-report-page__header-text">
        <h1 class="amw-report-page__title">{{ currentConfig.title }}</h1>
        @if (currentConfig.subtitle) {
        <p class="amw-report-page__subtitle">{{ currentConfig.subtitle }}</p>
        }
      </div>

      <div class="amw-report-page__header-actions">
        @if (currentConfig.showRefresh) {
        <amw-button icon="refresh" (click)="onRefresh()" [amwTooltip]="'Refresh'">
        </amw-button>
        }
        @if (currentConfig.showFullscreen) {
        <amw-button [icon]="isFullscreen ? 'fullscreen_exit' : 'fullscreen'"
          (click)="onToggleFullscreen()"
          [amwTooltip]="'Toggle Fullscreen'">
        </amw-button>
        }
        <amw-button icon="download" [matMenuTriggerFor]="exportMenu" [amwTooltip]="'Export'">
        </amw-button>
        <mat-menu #exportMenu="matMenu">
          <amw-button appearance="text" icon="picture_as_pdf" iconPosition="left" (click)="onExport('pdf')">
            Export as PDF
          </amw-button>
          <amw-button appearance="text" icon="table_chart" iconPosition="left" (click)="onExport('excel')">
            Export as Excel
          </amw-button>
          <amw-button appearance="text" icon="text_snippet" iconPosition="left" (click)="onExport('csv')">
            Export as CSV
          </amw-button>
        </mat-menu>
      </div>
    </div>
  </div>

  <!-- Date Range and Filters -->
  <div class="amw-report-page__controls">
    <amw-accordion-panel>
      <ng-template #header>
        <amw-icon name="tune"></amw-icon>
        Filters & Date Range
      </ng-template>

      <div class="amw-report-page__controls-content">
        <!-- Date Range -->
        @if (!loading && currentData.dateRange) {
        <div class="amw-report-page__date-range">
          <amw-select
            label="Date Range"
            name="dateRangePreset"
            [ngModel]="currentData.dateRange.preset"
            (ngModelChange)="onDateRangePresetChange($event)"
            [options]="dateRangePresetOptions"
            appearance="outline">
          </amw-select>
          @if (currentData.dateRange.preset === 'custom') {
          <amw-datepicker
            label="Start Date"
            name="startDate"
            [ngModel]="currentData.dateRange.start"
            (ngModelChange)="onDateRangeStartChange($event)"
            appearance="outline">
          </amw-datepicker>
          }
          @if (currentData.dateRange.preset === 'custom') {
          <amw-datepicker
            label="End Date"
            name="endDate"
            [ngModel]="currentData.dateRange.end"
            (ngModelChange)="onDateRangeEndChange($event)"
            appearance="outline">
          </amw-datepicker>
          }
        </div>
        }

        <!-- Filters -->
        @if (!loading && currentConfig.filters && currentConfig.filters.length > 0) {
        <div class="amw-report-page__filters">
          <div class="amw-report-page__filters-grid">
            @for (filter of currentConfig.filters; track filter) {
            <div class="amw-report-page__filter-field" [style.display]="filter.visible !== false ? 'block' : 'none'">
              @if (filter.type === 'text') {
              <amw-input
                [label]="filter.label"
                name="filter_{{ filter.key }}"
                [ngModel]="currentData.filters?.[filter.key]"
                (ngModelChange)="onFilterValueChange(filter.key, $event)"
                [placeholder]="filter.placeholder || ''"
                appearance="outline">
              </amw-input>
              }
              @if (filter.type === 'select') {
              <amw-select
                [label]="filter.label"
                name="filter_{{ filter.key }}"
                [ngModel]="currentData.filters?.[filter.key]"
                (ngModelChange)="onFilterValueChange(filter.key, $event)"
                [options]="getFilterSelectOptions(filter)"
                appearance="outline">
              </amw-select>
              }
              @if (filter.type === 'boolean') {
              <div class="amw-report-page__boolean-filter">
                <amw-switch name="filter_{{ filter.key }}" [ngModel]="currentData.filters?.[filter.key]"
                  (switchChange)="onFilterChange(filter.key, $event)">
                  {{ filter.label }}
                </amw-switch>
              </div>
              }
            </div>
            }
          </div>
        </div>
        }
      </div>
    </amw-accordion-panel>
  </div>

  <!-- Loading State -->
  @if (loading) {
  <div class="amw-report-page__loading">
    <amw-progress-spinner [diameter]="40"></amw-progress-spinner>
    <p>Loading report data...</p>
  </div>
  }

  <!-- Error State -->
  @if (error && !loading) {
  <div class="amw-report-page__error">
    <amw-icon name="error"></amw-icon>
    <p>{{ error }}</p>
    <amw-button appearance="elevated" color="primary" (click)="onRefresh()">Retry</amw-button>
  </div>
  }

  <!-- Report Content -->
  @if (!loading && !error) {
  <div class="amw-report-page__content">
    <!-- Widgets Grid -->
    <div class="amw-report-page__widgets-grid">
      @for (widget of currentData.widgets; track widget) {
      <div class="amw-report-page__widget" [class]="getWidgetSizeClass(widget.size)"
        [style]="getWidgetGridStyle(widget)" [style.display]="isWidgetVisible(widget) ? 'block' : 'none'">
        <amw-card class="amw-report-page__widget-card">
          <ng-template #cardHeader>
              @if (widget.type === 'chart') {
              <amw-icon name="bar_chart"></amw-icon>
              }
              @if (widget.type === 'table') {
              <amw-icon name="table_chart"></amw-icon>
              }
              @if (widget.type === 'metric') {
              <amw-icon name="analytics"></amw-icon>
              }
              @if (widget.type === 'progress') {
              <amw-icon name="trending_up"></amw-icon>
              }
              {{ widget.title }}
            <div class="amw-report-page__widget-actions">
              <amw-button icon="refresh" (click)="onRefreshWidget(widget)" [amwTooltip]="'Refresh'">
              </amw-button>
            </div>
          </ng-template>
          <ng-template #cardContent>
            <div (click)="onWidgetClick(widget)">
            <!-- Chart Widget -->
            @if (widget.type === 'chart') {
            <div class="amw-report-page__chart-widget">
              <div class="amw-report-page__chart-placeholder">
                <amw-icon name="bar_chart"></amw-icon>
                <p>Chart visualization would be rendered here</p>
                <p>Data: {{ widget.data | json }}</p>
              </div>
            </div>
            }
            <!-- Table Widget -->
            @if (widget.type === 'table') {
            <div class="amw-report-page__table-widget">
              <table mat-table [dataSource]="widget.data.rows" class="amw-report-page__table">
                @for (column of widget.data.columns; track column) {
                <ng-container [matColumnDef]="column.key">
                  <th mat-header-cell *matHeaderCellDef>{{ column.title }}</th>
                  <td mat-cell *matCellDef="let row">{{ row[column.key] }}</td>
                </ng-container>
                }
                <tr mat-header-row *matHeaderRowDef="getColumnKeys(widget.data.columns)"></tr>
                <tr mat-row *matRowDef="let row; columns: getColumnKeys(widget.data.columns)"></tr>
              </table>
            </div>
            }
            <!-- Metric Widget -->
            @if (widget.type === 'metric') {
            <div class="amw-report-page__metric-widget">
              <div class="amw-report-page__metric-value">{{ widget.data.value }}</div>
              <div class="amw-report-page__metric-label">{{ widget.data.label }}</div>
              @if (widget.data.change) {
              <div class="amw-report-page__metric-change">
                <amw-icon [name]="widget.data.change > 0 ? 'trending_up' : 'trending_down'"
                  [class.amw-report-page__metric-change--positive]="widget.data.change > 0"
                  [class.amw-report-page__metric-change--negative]="widget.data.change < 0">
                </amw-icon>
                {{ Math.abs(widget.data.change) }}%
              </div>
              }
            </div>
            }
            <!-- Progress Widget -->
            @if (widget.type === 'progress') {
            <div class="amw-report-page__progress-widget">
              <div class="amw-report-page__progress-label">{{ widget.data.label }}</div>
              <amw-progress-bar mode="determinate" [progressValue]="widget.data.value" class="amw-report-page__progress-bar">
              </amw-progress-bar>
              <div class="amw-report-page__progress-value">{{ widget.data.value }}%</div>
            </div>
            }
            <!-- Custom Widget -->
            @if (widget.type === 'custom') {
            <div class="amw-report-page__custom-widget">
              <p>Custom widget content would be rendered here</p>
              <p>Data: {{ widget.data | json }}</p>
            </div>
            }
            </div>
          </ng-template>
        </amw-card>
      </div>
      }
    </div>
    <!-- Empty State -->
    @if (currentData.widgets.length === 0) {
    <div class="amw-report-page__empty">
      <amw-icon name="assessment"></amw-icon>
      <p>No widgets configured</p>
    </div>
    }
  </div>
  }

  <!-- Footer -->
  @if (!loading && !error) {
  <div class="amw-report-page__footer">
    <div class="amw-report-page__footer-content">
      <span class="amw-report-page__last-updated">
        Last updated: {{ currentData.lastUpdated | date:'medium' }}
      </span>
    </div>
  </div>
  }
</div>